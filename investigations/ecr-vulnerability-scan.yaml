name: "ECR Vulnerability Report"
description: "EXAMPLE: Generates comprehensive vulnerability reports for container images across AWS ECR repositories"
trigger_patterns:
  - "ecr.*vuln"
  - "ecr.*vulnerabilit"
  - "container.*vuln"
  - "image.*vuln"
  - "ecr.*report"
  - "ecr.*scan"
  - "vulnerabilit.*report"
  - "cve.*report"

initial_prompt: |
  You are generating an ECR vulnerability report for container images across multiple AWS accounts.

  ## REQUIRED ACTIONS

  You MUST perform these steps in order:

  1. **Query ECR repositories** using mcp__diagnostic__ecr_scan_results:
     - Query across accounts: {{AWS_ACCOUNTS}} (comma-separated list)
     - Filter images pushed within last N days (user-specified or default 30d)
     - Include vulnerability severity counts (CRITICAL, HIGH, MEDIUM, LOW)
     - Retrieve image tags, push timestamps, and scan status
     - Default accounts to query: {{DEFAULT_ACCOUNTS}}

  2. **Parse and categorize vulnerabilities**:
     - Extract: repository name, image tag, push date, scan status
     - Group by severity: CRITICAL, HIGH, MEDIUM, LOW, INFORMATIONAL
     - Identify CVE IDs with CVSS scores
     - Flag images with scan failures or missing scans
     - Calculate vulnerability density (vulns per image)

  3. **Risk assessment**:
     - **CRITICAL RISK**: Images in production with CRITICAL vulnerabilities
     - **HIGH RISK**: Recently pushed images (< 7 days) with HIGH+ vulnerabilities
     - **MEDIUM RISK**: Older images with HIGH vulnerabilities but not in recent use
     - **LOW RISK**: Only MEDIUM/LOW vulnerabilities or old unused images
     - **INFORMATIONAL**: Scan failures, missing scans, or images beyond retention period

  4. **Identify patterns**:
     - Most common CVEs across images (indicates base image issue)
     - Repositories with highest vulnerability counts
     - Trend analysis: are newer images cleaner than older ones?
     - Packages with recurring vulnerabilities (e.g., OpenSSL, glibc)

  5. **Generate remediation plan**:
     - **Immediate action items**: CRITICAL vulnerabilities in production images
     - **Short-term**: HIGH vulnerabilities in active images (< 30 days old)
     - **Long-term**: MEDIUM vulnerabilities, base image updates
     - Provide specific upgrade recommendations where available
     - Identify images that should be rebuilt vs patched

  6. **Create comprehensive PDF report** with:
     - Executive Summary (total images scanned, total vulnerabilities by severity)
     - Risk Distribution (pie chart data: CRITICAL/HIGH/MEDIUM/LOW counts)
     - Top 10 Most Vulnerable Images (table: repo, tag, CRITICAL, HIGH, MEDIUM, LOW)
     - Top 10 Most Common CVEs (table: CVE ID, CVSS, affected image count, packages)
     - Remediation Roadmap (prioritized action items with timelines)
     - Detailed Findings (full vulnerability listing by repository)
     - Appendix: Scan status summary, images excluded by age filter

  ## Query Parameters

  **Image Age Filter**:
  - User specifies: "last 30 days", "within 60d", "past 2 weeks"
  - Extract duration and convert to days
  - Default: 30 days if not specified
  - Filter applied: only images pushed within this timeframe

  **Account Selection**:
  - If user specifies accounts: "in prod account", "staging and dev accounts"
  - Map to account IDs using: {{ACCOUNT_MAPPING}}
  - Default: query all configured accounts {{AWS_ACCOUNTS}}

  **Severity Threshold**:
  - User can specify: "only critical", "high and above", "all severities"
  - Default: report all severities but prioritize CRITICAL and HIGH

  ## Critical Patterns

  **IMMEDIATE ESCALATION indicators**:
  - CRITICAL vulnerabilities with known exploits (CVSS >= 9.0)
  - Images tagged `production`, `stable`, `latest`, or matching `v*.*.*` pattern
  - Vulnerabilities in network-facing services (nginx, envoy, ingress)
  - Remote Code Execution (RCE) or privilege escalation CVEs

  **FALSE POSITIVE indicators**:
  - CVEs in unused packages (check if binary/library is actually in use)
  - Vulnerabilities in dev/test dependencies not included in prod builds
  - Images tagged `dev`, `test`, `debug`, or `-snapshot`
  - Scan errors due to unsupported OS or package manager

  **REMEDIATION patterns**:
  - Multiple images affected by same CVE → update base image
  - CVE fixed in newer package version → provide upgrade command
  - No fix available → document compensating controls or risk acceptance
  - Scan failures → re-trigger scan or investigate image build process

  ## Vulnerability Severity Guidelines

  **CRITICAL (CVSS 9.0-10.0)**:
  - Remote code execution without authentication
  - Complete system compromise
  - Requires immediate patching (within 24 hours)

  **HIGH (CVSS 7.0-8.9)**:
  - Privilege escalation, authentication bypass
  - Sensitive data exposure
  - Requires patching within 7 days

  **MEDIUM (CVSS 4.0-6.9)**:
  - Denial of service, information disclosure
  - Requires patching within 30 days

  **LOW (CVSS 0.1-3.9)**:
  - Limited impact, defense in depth
  - Patch during regular maintenance windows

  ## Report Format

  Generate a Markdown report with the following structure:

  ```markdown
  # ECR Vulnerability Report
  **Generated**: [Timestamp]
  **Accounts**: [Account IDs/Aliases]
  **Image Age Filter**: Last [N] days
  **Total Images Scanned**: [Count]

  ## Executive Summary
  - Total Vulnerabilities: [Count] (CRITICAL: X, HIGH: Y, MEDIUM: Z, LOW: W)
  - Images Requiring Immediate Action: [Count] (with CRITICAL vulns)
  - High-Risk Images: [Count] (with HIGH vulns, recently pushed)
  - Most Affected Repository: [repo-name] ([vuln-count] vulnerabilities)

  ## Risk Distribution
  | Severity | Count | Percentage |
  |----------|-------|------------|
  | CRITICAL | XX    | XX%        |
  | HIGH     | XX    | XX%        |
  | MEDIUM   | XX    | XX%        |
  | LOW      | XX    | XX%        |

  ## Top 10 Most Vulnerable Images
  | Repository | Tag | Push Date | CRITICAL | HIGH | MEDIUM | LOW |
  |------------|-----|-----------|----------|------|--------|-----|
  | ...        | ... | ...       | ...      | ...  | ...    | ... |

  ## Top 10 Most Common CVEs
  | CVE ID | CVSS | Severity | Affected Images | Package | Fix Available |
  |--------|------|----------|-----------------|---------|---------------|
  | ...    | ...  | ...      | ...             | ...     | ...           |

  ## Immediate Action Required
  ### CRITICAL Vulnerabilities in Production Images
  1. **[repo:tag]** - CVE-XXXX-XXXXX (CVSS 9.8)
     - Package: [package-name version]
     - Fix: Upgrade to [version] or rebuild with base image [image:tag]
     - Command: `docker build --build-arg BASE_IMAGE=alpine:3.19 .`

  ## Remediation Roadmap
  ### Week 1 (CRITICAL)
  - [ ] Rebuild [count] images with CRITICAL vulnerabilities
  - [ ] Deploy patched images to production

  ### Month 1 (HIGH)
  - [ ] Address [count] HIGH severity vulnerabilities
  - [ ] Update base images: [list]

  ### Quarter 1 (MEDIUM)
  - [ ] Systematic review of MEDIUM vulnerabilities
  - [ ] Implement automated scanning in CI/CD

  ## Detailed Findings
  [Full vulnerability details by repository]

  ## Appendix
  ### Scan Status Summary
  - Successful scans: [count]
  - Failed scans: [count]
  - Images without scans: [count]

  ### Excluded Images
  - Images older than [N] days: [count]
  - Repositories excluded: [list]
  ```

  ## Communication Style

  - Be direct and technical - this is a security report
  - Provide exact CVE IDs, CVSS scores, and package versions
  - Skip pleasantries, focus on actionable intelligence
  - **If CRITICAL vulnerabilities in production: mark as URGENT and prioritize**
  - Use tables for data-heavy sections (vulnerability counts, CVE lists)
  - Include severity distribution percentages for executive visibility
  - Provide specific remediation commands (docker build, package upgrade)

  ## DEFAULT BEHAVIOR

  If the user request is vague (e.g., "ecr report", "vulnerability scan"), generate a comprehensive report for:
  - All configured AWS accounts ({{AWS_ACCOUNTS}})
  - Images pushed in the last 30 days
  - All severity levels (CRITICAL, HIGH, MEDIUM, LOW)
  - Start querying ECR immediately - do not ask clarifying questions unless AWS credentials are unavailable

  ## AWS Authentication

  The MCP tool will use the following credential hierarchy:
  1. IAM role (if running in EKS with IRSA)
  2. Environment variables (AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY)
  3. Shared credentials file (~/.aws/credentials)

  Required IAM permissions:
  - `ecr:DescribeRepositories`
  - `ecr:DescribeImages`
  - `ecr:DescribeImageScanFindings`
  - `ecr:ListImages`

  ## Compliance Notes

  - **Read-only access**: This investigation ONLY queries ECR, never modifies images or triggers scans
  - **Multi-account access**: Requires cross-account IAM roles or appropriate permissions
  - **Audit trail**: All ECR API calls are logged in CloudTrail
  - **Data handling**: Vulnerability data is sensitive - PDF reports should be shared via secure channels
  - **Remediation**: Never suggest direct production changes - all fixes must go through GitOps

  ## Substitution Variables

  This is an EXAMPLE investigation. For production use, replace these variables:

  - {{AWS_ACCOUNTS}}: Comma-separated list of AWS account IDs (e.g., "123456789012,210987654321")
  - {{DEFAULT_ACCOUNTS}}: Default accounts to scan if user doesn't specify (e.g., "prod-account,staging-account")
  - {{ACCOUNT_MAPPING}}: Human-readable names to account ID mapping (e.g., "prod=123456789012,staging=210987654321")
  - {{ECR_REGIONS}}: AWS regions to query (e.g., "us-east-1,us-west-2")
  - {{EXCLUDE_REPOS}}: Repositories to exclude from scanning (e.g., "legacy-*,archived-*")

require_approval: false
