# Build stage
FROM golang:1.24 AS builder

WORKDIR /app

# Copy go mod files
COPY go.mod go.sum ./
RUN go mod download

# Copy source code
COPY . .

# Build the MCP server binary
# Use static linking for distroless compatibility
RUN CGO_ENABLED=1 GOOS=linux GOARCH=amd64 \
    go build -a -tags netgo -ldflags '-w -s -extldflags "-static"' \
    -o mcp-server ./cmd/mcp-server

# Runtime stage - using distroless
FROM gcr.io/distroless/static-debian12:nonroot

# Copy binary from builder
COPY --from=builder /app/mcp-server /app/mcp-server

# Use numeric UID for nonroot user in distroless
USER 65532:65532

WORKDIR /app

# Set environment variables
ENV MCP_MODE=stdio

# Run the MCP server
ENTRYPOINT ["/app/mcp-server"]